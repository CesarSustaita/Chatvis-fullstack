<!DOCTYPE html>
<html lang="es-MX">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semantic Chatvis - Carga tu archivo</title>

    <!-- CSS de Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous"> -->

    <!-- CDN de FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Default custom style -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/default.css') }}">

    <!-- Charts CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>

    <script>
        var thisPageis = "analisis";
    </script>

    <div id="spinner-full-page" class="">
        <div class="spinner-border">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>

    <!-- Navbar -->
    {% include "navbar.html" %}

    <!-- Formulario de carga de archivo (Oculto) -->
    <input type="file" name="conversacion_exportada" id="chat_file_input" style="display: none;">

    {% if admin == 1 %}
    <!-- Toggle Usuarios | Analizador -->
    {% include "admin_tabbar.html" %}
    {% endif %}


    <!-- Contenido -->
    <div class="container py-1 py-sm-2">
        <!-- Título -->
        <div class="row my-1 my-sm-2 my-sm-3">
            <div class="col-12 d-flex flex-row align-items-center gap-3 justify-content-between">
                <div class="d-flex flex-row align-items-baseline gap-3 gap-md-4 gap-lg-5">
                    <h3 class="mb-1" id="chat-title" title="Nombre del chat">Análisis de la conversación</h3>
                    <!-- Contador de integrantes del chat -->
                    <p class="m-0 text-center" id="members-button" title="Integrantes del chat"
                    data-bs-toggle="modal"
                    data-bs-target="#modalMembersList"
                    onclick="populateMembersTable();">
                        <i class="fa-solid fa-users"></i>
                        <span id="chat-members-count">...</span>
                    </p>
                    <!-- Contador de mensajes del chat -->
                    <p class="m-0 text-center" id="chat-messages-count-container" title="Mensajes en el chat">
                        <i class="fa-regular fa-comments"></i> 
                        <span id="chat-messages-count">...</span>
                    </p>
                </div>
                <div class="d-flex flex-row align-items-baseline gap-1 gap-md-3 gap-lg-3">
                    <!-- Restart button -->
                    <button id="restart-button" class="btn btn-outline-secondary icon-btn btn-md my-2"
                    title="Reiniciar el análisis"
                    data-bs-toggle="modal"
                    data-bs-target="#modalRestartAnalysis">
                        <i class="fa-solid fa-arrow-rotate-right"></i>
                    </button>
                    <!-- Borrar chat button -->
                    <button id="delete-chat" class="btn btn-outline-secondary icon-btn btn-md my-2"
                    title="Eliminar el chat y el análisis"
                    data-bs-toggle="modal"
                    data-bs-target="#modalDeleteChat">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    
                </div>
            </div>
        </div>

        <!-- Cartas con gráficas -->
        <div class="row align-content-center">

            <!-- Chord diagram -->
            <div class="col-12 col-md-6 my-3">
                <div id="chord-card" class="card h-60vhi">
                    <div id="chord-card-header" class="card-header">
                        <div class="d-flex flex-row justify-content-between align-items-center">
                            <strong class="card-title m-0">Diagrama de cuerdas</strong>
                            <div class="d-flex flex-row justify-content-center align-items-center gap-2">
                                
                                <button class="btn btn-sm btn-close icon-btn d-block d-md-none" id="buttonCloseChord"
                                data-bs-toggle="collapse"
                                href="#chord-card-body"
                                aria-expanded="true"
                                aria-controls="chord-card-body"></button>
                            </div>
                        </div>
                    </div>

                    <div id="chord-card-body" class="card-body p-0 collapse show">
                        <div id="chord-chart-container" class="hideable-quick hideable-show">
                            <!-- Aquí se insertará el svg del diagrama de relaciones -->
                        </div>
                        <button class="btn btn-sm btn-outline-secondary icon-btn" id="buttonDownloadChord" onclick="downloadChordSVG();">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                
            </div>

            <!-- Chat -->
            <div class="col-12 col-md-6 my-3">
                <div id="chat-card" class="card h-60vhi">
                    <div class="card-header">
                        <div class="d-flex flex-row justify-content-between align-items-center">
                            <strong class="card-title m-0">Conversación</strong>
                            <button class="btn btn-sm btn-close icon-btn d-block d-md-none" id="buttonCloseChat" 
                            data-bs-toggle="collapse"
                            href="#chat-container"
                            aria-expanded="true" 
                            aria-controls="chat-container"></button>
                        </div>
                    </div>
                    <div id="chat-container" class="card-body p-0 collapse show">
                        <div title="Messages" id="chat" class="mh-100 py-2 px-3 hideable-quick hideable-show">
                            <!-- Aquí se llenará con los mensajes -->
                        </div>
                    </div>
                </div>
            </div>


            <!-- Histograma con clasificaciones -->
            <div class="col-12 my-3">
                <div id="histogram-card" class="card">
                    <div class="card-header">
                        <div class="d-flex flex-row justify-content-between align-items-center">
                            <strong class="card-title m-0">Análisis semántico</strong>
                            <button class="btn btn-sm btn-close icon-btn d-block d-md-none" id="buttonCloseHistogram"
                            data-bs-toggle="collapse"
                            href="#histogram-chart-container"
                            aria-expanded="true"
                            aria-controls="histogram-chart-container"></button>
                        </div>
                    </div>
                    <div id="histogram-chart-container" class="card-body collapse show hideable-quick hideable-show">
                        <div id="canvas-container" class="" style="position: relative; width: 100%; height: 60vh;">
                            <!-- Aquí se insertará el canvas del histograma -->
                            <canvas id="histogram-canvas" class="d-none"></canvas>
                        </div>
                        <div id="histogram-progress-bar" class="progress w-100">
                            <div
                                class="progress-bar progress-bar-striped progress-bar-animated w-100"
                                role="progressbar"
                                aria-valuenow="100"
                                aria-valuemin="0"
                                aria-valuemax="100"
                            >
                                <strong>
                                    Analizando...
                                </strong>
                            </div>
                        </div>
                        
                    </div>
                </div>
            
            

            

            
        </div>
    </div>
    
    <!-- Modal Eliminar Chat -->
    <div
        class="modal fade"
        id="modalDeleteChat"
        tabindex="-1"
        role="dialog"
        aria-labelledby="modalDeleteChatTitleID"
        aria-hidden="true"
    >
        <div
            class="modal-dialog modal-md modal-dialog-centered"
            role="document"
        >
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalDeleteChatTitleID">
                        ¿Eliminar chat y análisis?
                    </h5>
                    <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                    ></button>
                </div>
                <div class="modal-body px-3 py-3 py-lg-4 text-center">
                    <p class="inline-big-icon-text"> <i class="fa-solid fa-circle-info"></i> </p>
                    <p>Los archivos de chat se almacenan temporalmente solo en tu navegador.</p>
                    <p>Con esta opción puedes eliminarlos de inmediato.</p>
                </div>
                <div class="modal-footer">
                    <button id="button-confirm-delete-chat" type="button" class="btn btn-danger">
                        <i class="fas fa-trash-alt"></i> Eliminar
                    </button>
                    <button
                        type="button"
                        class="btn btn-dark"
                        data-bs-dismiss="modal"
                    >
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Reiniciar análisis -->
    <div class="modal fade" id="modalRestartAnalysis" tabindex="-1" role="dialog" aria-labelledby="modalRestartAnalysisTitleID"
        aria-hidden="true">
        <div class="modal-dialog modal-md modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalRestartAnalysisTitleID">
                        ¿Reiniciar el análisis?
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body py-3 py-lg-4 text-center">
                    <p class="text-warning inline-big-icon-text"><i class="fa-solid fa-triangle-exclamation"></i></p> 
                    <p> 
                        El progreso actual se perderá.
                    </p>
                </div>
                <div class="modal-footer">
                    <button id="button-confirm-restart-analysis" type="button" class="btn btn-warning" data-bs-dismiss="modal">
                        <i class="fa-solid fa-arrow-rotate-right"></i> Reiniciar análisis
                    </button>
                    <button type="button" class="btn btn-dark" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Lista de integrantes -->
    <div class="modal fade" id="modalMembersList" tabindex="-1" role="dialog"
        aria-labelledby="modalMembersListTitleID" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen-sm-down modal-dialog-scrollable modal-md modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalMembersListTitleID">
                        Integrantes de la conversación
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-3 p-lg-4">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped table-bordered m-0">
                            <thead>
                                <tr>
                                    <th scope="col" title="Color" class="text-center"><i class="fa-solid fa-palette"></i></th>
                                    <th scope="col" title="Nombre del integrante"><i class="fa-solid fa-user"></i> Nombre del integrante</th>
                                    <th scope="col" title="Número de mensajes" class="text-center"># <i class="fa-regular fa-comments"></i></th>
                                </tr>
                            </thead>
                            <tbody id="membersTableBody">
                                <!-- Aquí se llenará con los integrantes -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</body>


<!-- Dark mode script -->
<script src="{{ url_for('static', filename='js/darkmode.js') }}"></script>

<!-- * jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<!-- * WhatsApp Chat Parser: https://github.com/Pustur/whatsapp-chat-parser -->
<script src="https://cdn.jsdelivr.net/npm/whatsapp-chat-parser@4.0.0/dist/index.global.js"></script>

<!-- JavaScript de Bootstrap y sus dependencias (Popper) -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
    integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
    crossorigin="anonymous"></script>
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
    integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
    crossorigin="anonymous"></script> -->
    
<!-- Otros -->
<script src="{{ url_for('static', filename='js/d3.layout.chord.sort.js') }}"></script>

<!-- Chart.js -->
<!-- <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script> -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.js"
    integrity="sha512-L0Shl7nXXzIlBSUUPpxrokqq4ojqgZFQczTYlGjzONGTDAcLremjwaWv5A+EDLnxhQzY5xUZPWLOLqYRkY0Cbw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.js"
    integrity="sha512-7DgGWBKHddtgZ9Cgu8aGfJXvgcVv4SWSESomRtghob4k4orCBUTSRQ4s5SaC2Rz+OptMqNk0aHHsaUBk6fzIXw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<!-- * D3: https://github.com/d3/d3 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
<!-- <script src="https://cdn.jsdelivr.net/npm/d3@7"></script> -->

<!-- JavaScript de analisis -->
<script src="{{ url_for('static', filename='js/analisis.js') }}"></script>

<!-- JavaScript de chordDiagram -->
<script src="{{ url_for('static', filename='js/chordDiagramd3v3.js') }}"></script>


<!-- Toasts block -->
{% include "toasts.html" %}

</html>